<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim | SocialBook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="style.css" rel="stylesheet">
</head>
<body>

    <nav class="navbar navbar-light bg-light shadow-sm sticky-top d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand text-primary">PROFİL</span>
            <button id="sidebarToggleMobile" class="btn btn-primary">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div id="social-app-wrapper">
        
        <div class="sidebar d-print-block">
            <h4 class="mb-4 text-center text-primary">SOCIALBOOK</h4>
            
            <div id="userProfile" class="user-info-card mx-3 mb-4 text-center">
                <img src="https://via.placeholder.com/60" id="sidebarUserAvatar" class="rounded-circle mb-2 border" style="width: 60px; height: 60px; object-fit: cover;">
                <h6 class="mb-0"><b id="mainUserName">Misafir</b></h6>
                <span class="badge bg-primary" id="userRoleBadge">Kullanıcı</span>
                <p class="small text-muted mt-1">
                    <a href="index.html" class="text-danger" id="adminPanelLink" style="display:none;"><i class="fas fa-user-shield me-1"></i> Admin Paneline Git</a>
                </p>
            </div>
            
            <ul class="nav flex-column ps-3">
                <li class="nav-item mb-2"><a href="social_media_main.html" class="nav-link text-dark"><i class="fas fa-home me-2"></i> Ana Sayfa</a></li>
                <li class="nav-item mb-2"><a href="profile.html" class="nav-link text-dark fw-bold active"><i class="fas fa-user-circle me-2"></i> Profilim</a></li>
                <li class="nav-item mb-2">
                    <a class="nav-link text-dark" onclick="openFriendsModal()"> <i class="fas fa-users me-2"></i> Arkadaşlarım / Ara
                    </a>
                </li>
                <li class="nav-item mb-2"><a href="messages.html" class="nav-link text-dark"><i class="fas fa-envelope me-2"></i> Mesajlar</a></li>
                <li class="nav-item mb-2"><a href="settings.html" class="nav-link text-dark"><i class="fas fa-cog me-2"></i> Ayarlar</a></li>
            </ul>
            <div class="p-3 text-center position-absolute bottom-0 start-0 w-100">
                <button id="siteLogoutBtn" class="btn btn-danger w-75"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        
                        <div class="profile-container">
                            <header class="profile-header" id="profileHeader">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Yükleniyor...</span></div>
                                </div>
                            </header>

                            <ul class="nav nav-tabs mb-4">
                                <li class="nav-item"><a class="nav-link active" href="#" onclick="changeProfileTab(this, 'Gönderiler')"><i class="fas fa-th me-2"></i>Gönderiler</a></li>
                                <li class="nav-item"><a class="nav-link" href="#" onclick="changeProfileTab(this, 'Kaydedilenler')"><i class="fas fa-bookmark me-2"></i>Kaydedilenler</a></li>
                            </ul>

                            <div id="profileContent">
                                </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <input type="file" id="profileImageInput" accept="image/*" style="display: none;">

    <div class="modal fade" id="userListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userListModalTitle">Listesi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="userListContent" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Profil Fotoğrafını Kırp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-muted">Aşağıdaki yuvarlak alan içinde fotoğrafınızı yakınlaştırın veya kaydırın (Simülasyon).</p>
                    <div id="cropAreaContainer" style="width: 200px; height: 200px; border-radius: 50%; overflow: hidden; margin: 10px auto; border: 2px solid #ccc; position: relative;">
                        <img id="cropImagePreview" src="" style="width: 100%; height: auto; display: block; object-fit: cover; transition: all 0.1s ease;">
                    </div>
                    <input type="range" min="100" max="300" value="100" class="form-range mt-3" id="zoomSlider"> 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveCroppedImage">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade story-modal" id="storyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <div class="story-modal-header-content">
                        <span id="storyModalUser" class="fw-bold"></span>
                        <div id="storyModalControls"></div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="storyModalImage" src="" class="story-modal-image" alt="Story Image">
                </div>
                <div class="modal-footer border-0 p-3" id="storyCommentInput" style="background-color: transparent;">
                    <input type="text" class="form-control rounded-pill text-white" style="background-color: rgba(255,255,255,0.2); border:none;" placeholder="Hikayeye yanıt gönder...">
                    <button class="btn btn-sm btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="data_store.js"></script> 
    <script src="achievements_data.js"></script> 
    <script src="user_achievements.js"></script> 
    <script src="kullanici.js"></script>
    <script src="social-media.js"></script>
    
    <script>
        // Profil sekmesini değiştiren fonksiyon
        function changeProfileTab(el, tabName) {
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => link.classList.remove('active'));
            el.classList.add('active');
            // Yeni sekme içeriğini yüklemek için renderUserProfile çağrılır
            window.renderUserProfile();
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // Kullanıcı Kontrolü
            const userName = sessionStorage.getItem('CURRENT_USER_NAME');
            const userRole = sessionStorage.getItem('CURRENT_USER_ROLE') || 'member';
            
            if (!userName) {
                 window.location.href = 'login.html';
                 return;
            }

            // Rol ismini al
            const roleName = (window.ROLE_NAMES && window.ROLE_NAMES[userRole]) || userRole;

            const mainUserNameEl = document.getElementById('mainUserName');
            const userRoleBadgeEl = document.getElementById('userRoleBadge');
            const adminPanelLink = document.getElementById('adminPanelLink');
            
            if (mainUserNameEl) mainUserNameEl.textContent = userName;
            if (userRoleBadgeEl) userRoleBadgeEl.textContent = roleName; 
            if (adminPanelLink) {
                // Admin Panel linkini sürekli görünür yap
                adminPanelLink.style.display = (userRole !== 'member') ? 'inline' : 'none';
            }

            // Profil içeriğini yükle
            if (typeof window.renderUserProfile === 'function') {
                window.renderUserProfile();
            } else {
                console.error("renderUserProfile fonksiyonu bulunamadı! social-media.js dosyasını kontrol et.");
                document.getElementById('profileHeader').innerHTML = '<div class="alert alert-danger text-center">Profil yüklenirken bir hata oluştu. (JS Dosyası Eksik)</div>';
            }
            
            // Mobil Menü Toggle
            const mobileToggle = document.getElementById('sidebarToggleMobile');
            if (mobileToggle) {
                mobileToggle.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-toggled');
                });
            }
        });

        // Sidebar Çıkış Butonu
        const logoutBtn = document.getElementById('siteLogoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                 if (typeof window.logout === 'function') {
                      window.logout(); // Social-media.js'teki durum sıfırlayan logout'u çağır
                 } else {
                      sessionStorage.clear();
                      window.location.href = 'login.html';
                 }
            });
        }
        
        // openFriendsModal global olarak social-media.js'te tanımlıdır ve artık profile.html'de düzgün çalışmalıdır.
    </script>
</body>
</html>