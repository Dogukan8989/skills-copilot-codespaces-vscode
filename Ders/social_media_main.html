<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialBook | Ana Sayfa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="style.css" rel="stylesheet">
</head>
<body>

    <nav class="navbar navbar-light bg-light shadow-sm sticky-top d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand text-primary">SOCIALBOOK</span>
            <button id="sidebarToggleMobile" class="btn btn-primary">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>
    
    <div id="social-app-wrapper">
        
        <div class="sidebar d-print-block">
            <h4 class="mb-4 text-center text-primary">SOCIALBOOK</h4>
            
            <div id="userProfile" class="user-info-card mx-3 mb-4 text-center">
                <img src="https://via.placeholder.com/60" id="sidebarUserAvatar" class="rounded-circle mb-2 border" style="width: 60px; height: 60px; object-fit: cover;">
                
                <a href="profile.html" class="text-decoration-none text-dark" title="Profilime Git">
                    <h6 class="mb-0"><b id="mainUserName">Misafir</b></h6>
                </a>
                <span class="badge bg-primary" id="userRoleBadge">Kullanıcı</span>
                <p class="small text-muted mt-1">
                    <a href="index.html" class="text-danger" id="adminPanelLink" style="display:none;"><i class="fas fa-user-shield me-1"></i> Admin Paneline Git</a>
                </p>
            </div>
            
            <ul class="nav flex-column ps-3">
                <li class="nav-item mb-2"><a href="social_media_main.html" class="nav-link text-dark fw-bold"><i class="fas fa-home me-2"></i> Ana Sayfa (Feed)</a></li>
                <li class="nav-item mb-2"><a href="profile.html" class="nav-link text-dark"><i class="fas fa-user-circle me-2"></i> Profilim</a></li>
                <li class="nav-item mb-2">
                    <a href="#" class="nav-link text-dark" onclick="openFriendsModal()">
                        <i class="fas fa-users me-2"></i> Arkadaşlarım / Ara
                    </a>
                </li>
                <li class="nav-item mb-2"><a href="messages.html" class="nav-link text-dark"><i class="fas fa-envelope me-2"></i> Mesajlar</a></li>
                <li class="nav-item mb-2"><a href="settings.html" class="nav-link text-dark"><i class="fas fa-cog me-2"></i> Ayarlar</a></li>
            </ul>
            <div class="p-3 text-center position-absolute bottom-0 start-0 w-100">
                <button id="siteLogoutBtn" class="btn btn-danger w-75"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-12 col-lg-8 offset-lg-2"> 
                        
                        <div class="py-3">
                            <div class="card p-3 mb-4 shadow-sm post-card">
                                <form id="newPostForm">
                                    <div class="d-flex align-items-center">
                                        <img id="postCreatorAvatar" class="avatar-sm me-3 rounded-circle" src="https://via.placeholder.com/40/8c8c8c/ffffff?text=U" alt="User Avatar" style="width:40px; height:40px; object-fit:cover;">
                                        <input type="text" id="postContentInput" class="form-control rounded-pill me-2" placeholder="Aklınızdan ne geçiyor, Yazın...">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-1"></i> Gönder</button>
                                    </div>
                                </form>
                            </div>

                            <h5 class="text-muted">Hikayeler (Stories)</h5>
                            <div id="storyFeed" class="d-flex mb-5 gap-3 overflow-auto pb-2">
                                </div>
                            <input type="file" id="storyImageInput" accept="image/*" style="display: none;">

                            <h4>Ana Akış (Feed)</h4>
                            <div id="postFeed">
                                </div>

                            <div class="mt-5 mb-5 p-3 border rounded bg-light d-lg-none">
                                <h5 class="text-primary"><i class="fas fa-user-plus me-1"></i> Yeni Arkadaş Önerileri</h5>
                                <div id="suggestedUsersListMobile" class="row g-2">
                                    <div class="col-12 text-center text-muted small">Yükleniyor...</div>
                                </div>
                            </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-sidebar d-none d-md-block">
            <h5 class="text-danger mt-3"><i class="fas fa-bell me-1"></i> Bekleyen İstekler</h5>
            <div id="friendRequests">
                <div class="card p-3 text-center text-muted"><small>Yükleniyor...</small></div>
            </div>
            
            <hr class="mt-4">
            <h5 class="text-primary"><i class="fas fa-user-plus me-1"></i> Arkadaş Önerileri</h5>
            <div id="suggestedUsersListDesktop" class="list-group list-group-flush">
                 </div>
        </div>
        </div>
    
    <div class="modal fade story-modal" id="storyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <div class="story-modal-header-content">
                        <span id="storyModalUser" class="fw-bold"></span>
                        <div id="storyModalControls"></div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="storyModalImage" src="" class="story-modal-image" alt="Story Image">
                </div>
                <div class="modal-footer border-0 p-3" id="storyCommentInput" style="background-color: transparent;">
                    <input type="text" class="form-control rounded-pill text-white" style="background-color: rgba(255,255,255,0.2); border:none;" placeholder="Hikayeye yanıt gönder...">
                    <button class="btn btn-sm btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="newStoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"> 
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Yeni Hikaye Oluştur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="createStory(event)">
                        <div class="mb-3">
                            <label for="newStoryImage" class="form-label">Resim Bağlantısı (Opsiyonel)</label>
                            <input type="url" class="form-control" id="newStoryImage" placeholder="https://resim.com/hikaye.jpg">
                            <div class="form-text">Veya yukarıdaki "Hikaye Ekle" kartına tıklayarak dosya yükleyebilirsiniz.</div>
                        </div>
                        <div class="mb-3">
                            <label for="newStoryText" class="form-label">Metin İçeriği (Opsiyonel)</label>
                            <textarea class="form-control" id="newStoryText" rows="3" placeholder="Hikayenizdeki yazı..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Paylaş</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="friendsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search me-2"></i>Kullanıcı Bul & Takip Et</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" id="userSearchInput" class="form-control" placeholder="Kullanıcı adı ara..." onkeyup="searchUsers()">
                    </div>
                    <div id="searchResultsArea" style="display:none;">
                        <h6 class="text-muted">Arama Sonuçları</h6>
                        <div id="searchResultsList" class="list-group mb-4"></div>
                    </div>
                    <h6 class="text-primary mt-2">Tanıyor Olabileceğin Kişiler</h6>
                    <div id="suggestedUsersList" class="row g-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userListModalTitle">Listesi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="userListContent" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="data_store.js"></script> 
    <script src="achievements_data.js"></script> <script src="user_achievements.js"></script> <script src="kullanici.js"></script> 
    <script src="social-media.js"></script> 

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Kullanıcı Kontrolü
            const userName = sessionStorage.getItem('CURRENT_USER_NAME');
            const userRole = sessionStorage.getItem('CURRENT_USER_ROLE') || 'member';
            
            if (!userName) { window.location.href = 'login.html'; return; }

            const roleName = (window.ROLE_NAMES && window.ROLE_NAMES[userRole]) || userRole;
            document.getElementById('mainUserName').textContent = userName;
            document.getElementById('userRoleBadge').textContent = roleName;
            
            const adminLink = document.getElementById('adminPanelLink');
            if (adminLink) adminLink.style.display = (userRole !== 'member') ? 'inline' : 'none';

            // Javascript Fonksiyonlarını Tetikle
            if (typeof window.renderStories === 'function') window.renderStories(); 
            if (typeof window.renderFeed === 'function') window.renderFeed();
            if (typeof window.renderUserProfile === 'function') window.renderUserProfile();

            // KRİTİK DÜZELTME: Yeni Gönderi Formu Listener'ı
            const newPostForm = document.getElementById('newPostForm');
            const postContentInput = document.getElementById('postContentInput');
            const userRoleCheck = sessionStorage.getItem('CURRENT_USER_ROLE');
            const isStaff = ['super_admin', 'admin', 'moderator', 'manager', 'expert'].includes(userRoleCheck);
            
            if (newPostForm && postContentInput) {
                newPostForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const content = postContentInput.value.trim();
                    
                    if (!content) {
                        alert("Lütfen bir içerik girin.");
                        return;
                    }
                    
                    const postingUser = sessionStorage.getItem('CURRENT_USER_NAME');
                    
                    if (typeof window.addPostFromSocialMedia === 'function') {
                        window.addPostFromSocialMedia(postingUser, content);
                    }
                    
                    if (typeof window.renderFeed === 'function') window.renderFeed();
                    
                    postContentInput.value = ''; // Inputu temizle
                    
                    if (isStaff) {
                         alert("Gönderiniz anında yayınlandı (Yetkili Onayı Geçildi).");
                    } else {
                         alert("Gönderiniz başarıyla oluşturuldu, Yönetici/Uzman onayı bekleniyor.");
                    }
                });
            }
            
            // Mobil Menü Toggle
            const mobileToggle = document.getElementById('sidebarToggleMobile');
            if (mobileToggle) {
                mobileToggle.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-toggled');
                });
            }
            
            // Sayfa geri gelince yenile
            window.addEventListener('pageshow', function (event) {
                if (event.persisted) {
                    if (typeof window.renderStories === 'function') window.renderStories();
                    if (typeof window.renderFeed === 'function') window.renderFeed();
                }
            });
            
            // Sağ Sidebar/Mobil Önerileri manuel tetikle
            const desktopList = document.getElementById('suggestedUsersListDesktop');
            const mobileList = document.getElementById('suggestedUsersListMobile');
            if (desktopList && typeof renderSuggestedUsers === 'function') {
                 renderSuggestedUsers(desktopList, true); 
            }
            if (mobileList && typeof renderSuggestedUsers === 'function') {
                 renderSuggestedUsers(mobileList);
            }
            
        });

        // Çıkış İşlemi
        const logoutBtn = document.getElementById('siteLogoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                 if (typeof window.logout === 'function') {
                      window.logout(); // Social-media.js'teki durum sıfırlayan logout'u çağır
                 } else {
                      sessionStorage.clear();
                      window.location.href = 'login.html';
                 }
            });
        }

        // Rapor ve Beğeni (Inline fonksiyonlar)
        function reportPost(postId) {
            const reportReason = prompt("Şikayet sebebi:");
            if (reportReason) {
                const reportingUser = sessionStorage.getItem('CURRENT_USER_NAME') || 'Bilinmeyen Kullanıcı';
                if (typeof window.logReport === 'function') {
                     window.logReport(reportingUser, postId, reportReason);
                }
                alert("Şikayet edildi.");
            }
        }
        
        // likePost ve addCommentToPost artık social-media.js içinde tanımlıdır
        // ve HTML'deki onclick olayları tarafından doğrudan çağrılacaktır.
    </script>
</body>
</html>